---
title: "I use Arch btw."
date: 2025-09-01
permalink: /posts/2025/09/arch/
tags:
  - linux
  - arch
  - thinkpad
  - grub
  - btrfs
  - snapper
  - rclone
---
Here is a documentation to get started with [the best operating system](https://wiki.archlinux.org/title/Arch_is_the_best).

I was introduced to Linux via [Canonical's advertisement program](https://ubuntu.com/blog/ubuntu-7-04-wins-a-100-best-products-of-2007-award-from-pc-world) that it ran with PCWorld magazine, in which the accompanying CD had latest Ubuntu version and other software updates. This led to Linux explorations (including weirdos like [BOSS Linux](https://distrowatch.com/table.php?distribution=BOSS), [Puppy Linux](https://distrowatch.com/table.php?distribution=puppy), [Peppermint](https://distrowatch.com/table.php?distribution=peppermint),...) in VirtualBox running on Windows XP. However, being unable to keep up with Microsoft Windows' increasing system requirements, I ended up using Lubuntu once Windows XP reached end of life. Since then, over the last 20 years, I have had the pleasure of working on the three major Linux distro families: `APT` (Debian/Ubuntu/Linux_Mint/Tuxedo_OS/Kali_Linux), `DNF` (Fedora/RHEL/CentOS), and `ZYpp` (SLE/openSUSE). You can read my long rants about various Linux distros in one of [my old blog post](https://gkorpal.github.io/posts/2020/08/distrohopping/). 

Over time, I have developed a sense of what I want and am ready to be responsible for my Thinkpad P16 :) Long term Linux users might enjoy this [comparison of Arch with other distros](https://wiki.archlinux.org/title/Arch_compared_to_other_distributions).

I learned about the process from the [official guide](https://wiki.archlinux.org/title/Installation_guide) and supplemented it with the notes by [Michele Gementi](https://gist.github.com/mjkstra/96ce7a5689d753e7a6bdd92cdc169bae), [Max Pershin](https://github.com/silentz/arch-linux-install-guide), [Abhishek Prakash](https://itsfoss.com/install-arch-linux/), [quantinium](https://github.com/quantinium3/Guide-to-install-Arch-Linux), [Daniel Wayne Armstrong](https://www.dwarmstrong.org/btrfs-snapshots-rollbacks/), [Gentoo](https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks#Partitioning_the_disk_with_GPT_for_UEFI) and [Ubuntu](https://help.ubuntu.com/community/SwapFaq).

I will follow the [Arch Wiki convention](https://wiki.archlinux.org/title/Help:Reading): The numeral or hash sign (`#`) indicates that the command needs to be run as *root*, whereas the dollar sign (`$`) shows that the command should be run as a *regular user*. 

## Preparation

1. Download the latest `archlinux-YYYY.MM.DD-x86_64.iso`, `sha256sums.txt`, and `archlinux-YYYY.MM.DD-x86_64.iso.sig` from the [nearest mirror](https://archlinux.org/download/#download-mirrors) like `mirror.arizona.edu`.
2. Verify the integrity and authenticity of your ISO image using Linux (if Windows, use WSL). 
    1. Integrity: Ensure the download image matches the checksum from the `sha256sums.txt`
        ````
        $ sha256sum -c sha256sums.txt
        ````
        This should output `archlinux-YYYY.MM.DD-x86_64.iso: OK`. You may see "No such file or directory" for other files which we didn't download but their checksums also included.
    2. Authenticity: One should never use a GnuPG version just downloaded from internet to check the integrity; instead use an existing, trusted GnuPG installation, e.g., the one provided by your Linux distribution (if Windows, then use WSL).
        ````
        $ gpg --auto-key-locate clear,wkd -v --locate-external-key pierre@archlinux.org
        $ gpg --verify archlinux-YYYY.MM.DD-x86_64.iso.sig archlinux-YYYY.MM.DD-x86_64.iso
        ````
        GPG might give warning `This key is not certified with a trusted signature!`, but you can verify it [here](https://pierre-schmitz.com/gpg-keys/).
3. Create a bootable USB drive using [Ventoy](https://www.ventoy.net/en/download.html); remember to verify the checksum of Ventoy itself.
4. In BIOS, disable [secure boot](https://xkcd.com/1200/).
5. Check ArchLinux [website status](https://status.archlinux.org/) since they are prone to [DDoS attacks](https://lists.archlinux.org/archives/list/arch-general@lists.archlinux.org/thread/EU4NXRX6DDJAACOWIRZNU4S5KVXEUI72/). Also, the services may send an initial connection reset due to the TCP SYN authentication performed by the hosting provider, but subsequent requests should work as expected.
    1. In the case of downtime for `archlinux.org`:
        1. Mirrors: The mirror list endpoint used in tools like `reflector` is hosted on this site. Please default to the mirrors listed in the `pacman-mirrorlist` package during an outage.
        2. ISO: Installation image is available on a lot of the mirrors, for example the DevOps administered [geomirrors](https://geo.mirror.pkgbuild.com/iso/). Please always verify its integrity.
    2. In the case of downtime for `aur.archlinux.org`:
        1. Packages: A mirror of AUR packages is maintained on GitHub. You can retrieve a package using: 
            ````
            $ git clone --branch <package_name> --single-branch https://github.com/archlinux/aur.git <package_name>
            ```` 

## CLI setup

1. Boot from the USB drive and select Arch Linux from [the `systemd-boot` greeting screen](https://wiki.archlinux.org/title/Installation_guide#Boot_the_live_environment) to get logged in on the first virtual console as the root user, and presented with a Zsh shell prompt.
2. Verify that the boot mode is UEFI by ensuring that the following command returns 64.
    ````
    # cat /sys/firmware/efi/fw_platform_size
    ````
3. Connect to WiFi using `iwctl`.
    ````
    # iwctl
    [iwd]# device list
    [iwd]# station <device-name> scan
    [iwd]# station <device-name> get-networks
    [iwd]# station <device-name> connect <Name of WiFi access point>
    [iwd]# exit
    $ ping -c 5 ping.archlinux.org
    ````
4. Ensure that the system clock is syncronized via Network Time Protocol (NTP).
    ````
    # timedatectl set-ntp true
    ````
5. Use `cfdisk` to create the following GUID Partition Table (GPT), without hibernation feature (suspend-to-disk).
    | Mount point | Parition type | Size | Partition |
    | ----------- | ------------- | ---- | -------- |
    | `/efi`     |  EFI System Partition | 1 GiB | `/dev/efi_system_partition` |
    | `[swap]`    | Linux swap |  6 GiB | `/dev/swap_partition` |
    | `/`         | Linux Filesystem | (all of the remaining space ) | `/dev/root_partition` |

    Can later get the partition names using `fdisk -l`. 
6. Format the partitions using `mkfs`.
    ````
    # mkfs.fat -F 32 /dev/efi_system_partition
    # mkswap /dev/swap_partition
    # mkfs.btrfs /dev/root_partition
    ````
7. Create the Btrfs filesystem layout [recommended for `snapper`](https://wiki.archlinux.org/title/Snapper#Suggested_filesystem_layout) 
    ````
    # mount /dev/root_partition /mnt
    # btrfs subvolume create /mnt/@
    # btrfs subvolume create /mnt/@home
    # btrfs subvolume create /mnt/@var_log
    # btrfs subvolume create /mnt/@var_cache
    # btrfs subvolume create /mnt/@var_spool
    # btrfs subvolume create /mnt/@var_tmp
    # btrfs subvolume create /mnt/@snapshots
    # umount /mnt
    ````
8. Mount the file systems as we prepare to [chroot](https://wiki.archlinux.org/title/Chroot#Running_on_Btrfs) with [Btrfs compression settings](https://btrfs.readthedocs.io/en/latest/Administration.html#notes-on-generic-mount-options) optimized for NVMe SSD (Kioxia XG8) and not using [Mutt](https://wiki.archlinux.org/title/Mutt).
    ````
    # mount -o noatime,compress=zstd:1,subvol=@ /dev/root_partition /mnt
    # mkdir -p /mnt/{home,var/log,var/cache,var/spool,var/tmp,.snapshots}
    # mount -o noatime,compress=zstd:1,subvol=@home /dev/root_partition /mnt/home
    # mount -o noatime,compress=zstd:1,subvol=@var_log /dev/root_partition /mnt/var/log
    # mount -o noatime,compress=zstd:1,subvol=@var_cache /dev/root_partition /mnt/var/cache
    # mount -o noatime,compress=zstd:1,subvol=@var_spool /dev/root_partition /mnt/var/spool
    # mount -o noatime,compress=zstd:1,subvol=@var_tmp /dev/root_partition /mnt/var/tmp
    # mount -o noatime,compress=zstd:1,subvol=@snapshots /dev/root_partition /mnt/.snapshots
    # mount --mkdir /dev/efi_system_partition /mnt/efi
    # swapon /dev/swap_partition
    ````
9. Install the following set of packages from the [official repositories](https://wiki.archlinux.org/title/Official_repositories):
    1. core packages: `base`, `linux`, `linux-firmware`
    2. utilities: `base-devel`, `reflector`, `sudo`, `git`, `openssh`, `rclone`
    3. CPU microcode updates ([Intel Alder Lake](https://wiki.archlinux.org/title/Microcode#)): `intel-ucode`
    4. boot loader ([GRUB](https://wiki.archlinux.org/title/GRUB#Installation)): `grub`, `efibootmgr`
    5. userspace utilities for the file system ([Btrfs](https://wiki.archlinux.org/title/Snapper#Wrapping_pacman_transactions_in_snapshots)): `btrfs-progs`, `grub-btrfs`, `inotify-tools`, `snapper`, `snap-pac`
    6. device specific firmware
        1. graphics ([Intel Alder Lake UHD](https://wiki.archlinux.org/title/Intel_graphics) and [NVIDIA Ampere](https://wiki.archlinux.org/title/NVIDIA)): `mesa`, `vulkan-intel`, `nvidia`, `nvidia-utils`, `nvidia-settings`
        2. audio ([Dolby Atmos](https://wiki.archlinux.org/title/Lenovo_ThinkPad_T14_(AMD)_Gen_4#Speakers)): `pipewire`, `pipewire-alsa`, `pipewire-pulse`, `pipewire-jack`, `wireplumber`
        3. resource management ([Lenovo Vantage](https://wiki.archlinux.org/title/Laptop/Lenovo#Lenovo)): `fwupd`, `tlp`
    7. networking software: `networkmanager`
    8. console text editor: `nano` 
    9. documentation: `man-pages`

    Run the following command
    ````
    # pacstrap -K /mnt <space separated list of packages>
    ````
    This also creates a new `initramfs` (*init*ial *RAM* *f*ile *s*ystem), because `mkinitcpio` is run on installation of the kernel package with `pacstrap`. 
10. Generate `fstab` file with startup instructions
    ````
    # genfstab -U /mnt >> /mnt/etc/fstab
    ````
    Check the resulting [`/mnt/etc/fstab` file](https://wiki.archlinux.org/title/Fstab#Usage), and edit it in case of errors. 
11. Switch to the new system's environment
    ````
    # arch-chroot /mnt
    ````
    1. Set up the time zone
        ````
        # ls /usr/share/zoneinfo/                                     
        # ls /usr/share/zoneinfo/<Zone>/                              
        # ln -sf /usr/share/zoneinfo/<Zone>/<Subzone> /etc/localtime       
        # hwclock --systohc
        ````
    2. Locale settings configuration
        1. Use `nano` to edit `/etc/locale.gen` and uncomment `en_US.UTF-8 UTF-8`.
        2. Generate the locales.
           ````
           # locale-gen
           ````
        4. Use `nano` to create configuration file `/etc/locale.conf` and write `LANG=en_US.UTF-8` in it.
    3. Network configuration.
        1. Use `nano` to create  `/etc/hostname` and write `<PC-Name>` in it.
        2. Use `nano` to edit `/etc/hosts` and add the following to it
           ````
           127.0.0.1 localhost
           ::1 localhost
           127.0.1.1 <PC-Name> 
           ````
        3. Enable network manager to run on boot.
           ````
           # systemctl enable NetworkManager
           ````
    4. Enable TLP to [run on boot](https://wiki.archlinux.org/title/TLP#Installation).
       ````
       # systemctl enable tlp.service
       ````
    5. Snapshot configuration as [per the Wiki](https://wiki.archlinux.org/title/Snapper#Configuration_of_snapper_and_mount_point).
        1. Unmount `/.snapshots`
           ````
           # btrfs subvolume list -t /
           # lsblk --fs
           # blkid
           # umount /.snapshots
           # rm -r /.snapshots
           ````
        2. Create a new snapper configuration named `root` for the Btrfs subvolume at `/`.
            ````
            # snapper -c root create-config /
            # btrfs subvolume delete /.snapshots
            # mkdir /.snapshots
            # mount -o noatime,compress=zstd:1,subvol=@snapshots /dev/root_partition /.snapshots
            # nano /etc/fstab
            # mount -a
            # chmod 750 /.snapshots
            ````
            This will create a configuration file at `/etc/snapper/configs/root`. When you delete config file, then also delete its entry from [`/etc/conf.d/snapper`](https://github.com/openSUSE/snapper/issues/371#issuecomment-1451093540) to read `SNAPPER_CONFIGS=""`. To restore `/` using one of snapper's snapshots, first boot into a live Arch Linux USB/CD and then [follow these steps](https://wiki.archlinux.org/title/Snapper#Restoring_/_to_its_previous_snapshot ).
        3. Use the provided [systemd timer units](https://wiki.archlinux.org/title/Systemd/Timers) for automatic timeline snapshots and cleanup. 
           ````
           # systemctl start snapper-timeline.timer
           # systemctl enable snapper-timeline.timer
           # systemctl start snapper-cleanup.timer
           # systemctl enable snapper-cleanup.timer
           ````
           Unlike Timeshift, we will [not use cron job](https://wiki.archlinux.org/title/Cron#Installation). Moreover, we are using [`snap-pac`](https://barnettphd.com/snap-pac/examples.html) package to make pacman automatically use snapper to create pre/post snapshots.
        4. Change snapshot and cleanup frequencies by editing `snapper-timeline.timer` and `snapper-cleanup.timer` units.
            ````
            # systemctl edit --full snapper-timeline.timer
            # systemctl edit --full snapper-cleanup.timer
            ````
            For taking snapshots use realtime timer `OnCalendar=hourly` and for cleanup use monotomic timer `OnBootSec=10m` and `OnUnitActiveSec=1h`.
        5. Set snapshot limits by editing `/etc/snapper/configs/root`
           ````
           # limit for number cleanup
           NUMBER_MIN_AGE="1800"
           NUMBER_LIMIT="10"
           NUMBER_LIMIT_IMPORTANT="5"

           # limits for timeline cleanup
           TIMELINE_MIN_AGE="1800"
           TIMELINE_LIMIT_HOURLY="5"
           TIMELINE_LIMIT_DAILY="7"
           TIMELINE_LIMIT_WEEKLY="0"
           TIMELINE_LIMIT_MONTHLY="0"
           TIMELINE_LIMIT_YEARLY="0"

           # limits for empty pre-post-pair cleanup
           EMPTY_PRE_POST_MIN_AGE="1800"
           ````
           Here 1800 seconds = 30 min.
        6. snapper list `# snapper -c config list`
        7. Automatically update GRUB upon snapshot creation or deletion using the [`grub-btrfs` daemon](https://github.com/Antynea/grub-btrfs?tab=readme-ov-file#-automatically-update-grub-upon-snapshot-creation-or-deletion).
           ````
           # systemctl start grub-btrfsd
           # systemctl enable grub-btrfsd
           ````
        8. Enable booting into read-only snapshots using [overlay filesystem](https://github.com/Antynea/grub-btrfs/blob/master/initramfs/readme.md) by adding `grub-btrfs-overlayfs` to the end of the `HOOKS` array in `/etc/mkinitcpio.conf` and regenerating the `initramfs`.
           ````
           # nano /etc/mkinitcpio.conf
           # mkinitcpio -P
           ````
           New error: "Failed to start Remount Root and Kernel File Systems." https://forum.manjaro.org/t/failed-to-start-remount-root-and-kernel-file-system/67867/17
    6. Root and users.
        1. Set root password using `passwd` command.
        2. Add yourself as an admin user
           ````
           # useradd -mG wheel <user-name>
           # passwd <user-name>
           # EDITOR=nano visudo
           ````
           The [last command](https://wiki.archlinux.org/title/Sudo#Using_visudo) opens the `/etc/sudoers` file using `nano`; look for a line which says something like `Uncomment to allow members of group wheel to execute any command` and uncomment exactly the line BELOW it, by removing the `#`. This will grant superuser priviledges to your user.
    9. Deploy and configure the boot loader.
        ````
        # grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id=GRUB
        # grub-mkconfig -o /boot/grub/grub.cfg
        ````
    10. Exit the chroot environment by typing `exit` or pressing <kbd>Ctrl</kbd> + <kbd>d</kbd>.
11. Manually unmount all the partitions
    ````
    # umount -R /mnt
    ````
12. Reboot the system and remove the installation media
    ````
    # reboot
    ````

## GUI setup 

1. Log into the user account `<user-name>`.
2. Connect to WiFi using `nmtui` or `nmcli`.
    ````
    $ nmcli device wifi connect <Name of WiFi access point> password <password>
    ````
7. Check [firmware updatable devices](https://wiki.archlinux.org/title/Fwupd#Usage).
    ````
    $ fwupdmgr get-devices
    ````
8. Check [NVIDIA configuration](https://wiki.archlinux.org/title/NVIDIA#Wayland_configuration) by ensuring that the Direct Rendering Manager (DRM) is enabled.
9. Install KDE with [Wayland support](https://archlinux.org/news/plasma-640-will-need-manual-intervention-if-you-are-on-x11/) following advice from the [KDE documentation](https://community.kde.org/Distributions/Packaging_Recommendations) and Arch dependency tree of [`plasma-desktop`](https://archlinux.org/packages/extra/x86_64/plasma-desktop/).
    1. base: `plasma-{desktop,pa,nm,systemmonitor,firewall}`, `kscreen`, `bluedevil`
    2. keyring ([PAM](https://wiki.archlinux.org/title/KDE_Wallet#Unlock_KDE_Wallet_automatically_on_login)): `kwalletmanager`, `kwallet-pam`
    3. terminal (otherwise will need to use [`tty`](https://wiki.archlinux.org/title/Linux_console)): `konsole`
    4. file manager: `dolphin`, `dolphin-plugins`, `kdegraphics-thumbnailers`, `ffmpegthumbs`
    5. XDG Desktop Portal ([Wayland and Firefox integration](https://wiki.archlinux.org/title/XDG_Desktop_Portal)): `xdg-desktop-portal-gtk`, `xdg-desktop-portal-kde`
    6. Theme consistency ([GTK in Qt](https://wiki.archlinux.org/title/Uniform_look_for_Qt_and_GTK_applications#Styles_for_both_Qt_and_GTK)): `breeze-gtk`, `kde-gtk-config`
    
    ````
    $ sudo pacman -S   <space separated list of packages>    
    ````
    You may be prompted to choose between [`ffmpeg`](https://archlinux.org/packages/extra/x86_64/qt6-multimedia-ffmpeg/) or [`gstreamer`](https://archlinux.org/packages/extra/x86_64/qt6-multimedia-gstreamer/) backend for `qt6-multimedia`. I chose `ffmpeg` because that [seems to be the default](https://code.qt.io/cgit/qt/qtmultimedia.git/commit/?id=5a5fc56e06500c427f4db8666aa103151748588e).
   
    We have consciously excluded `discover` from KDE because is can lead to partial upgrades [which are unsupported in Arch](https://wiki.archlinux.org/title/System_maintenance#Partial_upgrades_are_unsupported).
10. Install Simple Desktop Display Manager (SDDM).
    ````
    $ sudo pacman -S sddm
    $ sudo systemctl enable sddm
    $ sudo pacman -S --needed sddm-kcm
    ````
11. Reboot to finalize installation.
    ````
    $ reboot
    ````
    
## Initial setup

1. Login using SDDM.
2. Go to `Settings` &rarr; `Colors & Themes` &rarr; `Login Screen (SDDM)` &rarr; `Breeze` &rarr; `Change Background` &rarr; `Apply`.
3. Configure snapper https://wiki.archlinux.org/title/Snapper#Creating_a_new_configuration
4. Check TLP status and configure if needed. You can configure `tlp` by editing [battery care settings](https://linrunner.de/tlp/settings/bc-vendors.html) in `/etc/tlp.conf`.
    ````
    $ sudo tlp-stat -s
    $ sudo tlp-stat -b
    ````
5. backup on cloud using `rclone` https://wiki.archlinux.org/title/List_of_applications/Internet#Cloud_synchronization_clients
6. Reboot and check if things if the things are as expected.

## Maintainance

full upgrade: pacman -Syu

Before we begin, 
https://en.wikipedia.org/wiki/Package_manager#Comparison_of_commands

Pacman: https://wiki.archlinux.org/title/Pacman/Rosetta

Pacman queries the local package database with the `-Q` flag, the sync database with the `-S` flag and the files database with the `-F` flag.

pacman is short for package manager.

https://www.reddit.com/r/linux4noobs/comments/xin1zo/why_do_package_managers_have_such_difficult_names/

https://pkgstats.archlinux.de/fun

1. Installed from official repositories using `pacman`.
    1. Browser: `firefox` (along with extensions: uBlock Origin, Privacy Badger, Decentraleyes, ClearURLs, and password manager) 
    2. Document viewer: `okular`, `ebook-tools`, `kdegraphics-mobipocket`, `unarchiver`
    3. Image viewer: `gwenview`, `kimageformats`, `qt6-imageformats`
    4. Video player ([mpv](https://wiki.archlinux.org/title/Mpv) based): `haruna`, `yt-dlp`
    5. Archiving tool: `ark`, `7zip`
    6. Screenshot tool: `spectacle`
    7. Calculator: `kalk`
    8. Text editor: `kate`
    9. File searching tool: `kfind`
    10. Messaging: `signal-desktop`
    12. Webcam controls ([LogiTune](https://wiki.archlinux.org/title/Webcam_setup#Graphical)): `cameractrls`
    13. Wireless mouse ([LogiBolt](https://wiki.archlinux.org/title/Logitech_Unifying_Receiver)): `solaar`





boot from a snapshot if something goes wrong. 
https://wiki.archlinux.org/title/Btrfs#Booting_into_snapshots
It might lead to following warning

````
********************* WARNING *********************
* The root device is not configured to be mounted *
* read-write! It may be fsck'd again later.       *
***************************************************
````

https://bbs.archlinux.org/viewtopic.php?id=167153

tried to fix 
https://bbs.archlinux.org/viewtopic.php?id=304206

https://wiki.archlinux.org/title/Snapper#Booting_into_read-only_snapshots


https://wiki.archlinux.org/title/General_troubleshooting

https://wiki.archlinux.org/title/Downgrading_packages

https://www.reddit.com/r/archlinux/comments/n1zw5s/what_are_some_aur_packages_that_are_a_musthave_in/

https://wiki.archlinux.org/title/System_maintenance

https://github.com/Antynea/grub-btrfs

https://bbs.archlinux.org/viewtopic.php?id=297446


---

