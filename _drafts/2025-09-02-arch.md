---
title: "Arch Linux on Thinkpad P16"
date: 2022-07-01
permalink: /posts/2025/09/arch/
tags:
  - linux
  - arch
  - thinkpad
---

During my PhD I had to resort to using WSL because university required Microsoft and Adobe software. However, WSL is wasteful because of useless host: https://learn.microsoft.com/en-us/windows/wsl/wsl-config#main-wsl-settings

This pose is a continuation of https://gkorpal.github.io/posts/2020/08/fedora/

This is my attempt to create something inspired by up-to-date packages and kernel of Fedora, KDE of OpenSUSE, and large package availability of Ubuntu. I desire a bit more control over my machine than ofference by these three.

## Installation steps:
I learned about the process from the [official guide](https://wiki.archlinux.org/title/Installation_guide) and supplemented it with the notes by [Michele Gementi](https://gist.github.com/mjkstra/96ce7a5689d753e7a6bdd92cdc169bae), [Max Pershin](https://github.com/silentz/arch-linux-install-guide), [Abhishek Prakash](https://itsfoss.com/install-arch-linux/), [quantinium](https://github.com/quantinium3/Guide-to-install-Arch-Linux), [Gentoo guide](https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks#Partitioning_the_disk_with_GPT_for_UEFI) and [Ubuntu guide](https://help.ubuntu.com/community/SwapFaq).

1. Download the latest ISO from U of A's mirror: https://mirror.arizona.edu/
2. Create a bootable USB drive using Ventoy: https://www.ventoy.net/en/doc_start.html
3. In BIOS disable OS-Optimized defaults and [secure boot](https://arstechnica.com/security/2024/07/secure-boot-is-completely-compromised-on-200-models-from-5-big-device-makers/): https://support.lenovo.com/us/en/solutions/ht509044-how-to-enable-secure-boot-on-think-branded-systems-thinkpad-thinkstation-thinkcentre
4. Boot from the USB drive and select Arch Linux. Will get logged in on the first virtual console as the root user, and presented with a Zsh shell prompt.
5. Verify that the boot mode is UEFI by ensuring that the following command returns 64.
    ````
    $ cat /sys/firmware/efi/fw_platform_size
    ````
6. Connect to WiFi using `iwctl`.
    ````
    $ iwctl
    [iwd]# device list
    [iwd]# station <device-name> scan
    [iwd]# station <device-name> get-networks
    [iwd]# station <device-name> connect <Name of WiFi access point>
    [iwd]# exit
    $ ping -c 5 ping.archlinux.org
    ````
7. Ensure that the system clock is syncronized via Network Time Protocol (NTP).
    ````
    $ systemctl enable systemd-timesyncd.service
    $ timedatectl
    ````
8. Use `cfdisk` to create the following GUID Partition Table (GPT), without hibernation feature (suspend-to-disk).
    | Mount point | Parition type | Size |
    | ----------- | ------------- | ---- |
    | `/efi`     |  EFI System Partition | 1 GiB |
    | `[swap]`    | Linux swap |  6 GiB |
    | `/`         | Linux Filesystem | (all of the remaining space ) |
9. Format the partitions using `mkfs`
    ````
    $ mkfs.btrfs </dev/root_partition>
    $ mkfs.fat -F 32 </dev/efi_system_partition>
    $ mkswap </dev/swap_partition>
    ````
10. Mount the file systems
    ````
    $ mount </dev/root_partition> /mnt
    $ btrfs subvolume create /mnt/@
    $ btrfs subvolume create /mnt/@home
    $ umount /mnt
    $ mount -o compress=zstd,subvol=@ </dev/root_partition> /mnt
    $ mkdir -p /mnt/home
    $ mount -o compress=zstd,subvol=@home </dev/root_partition> /mnt/home
    $ mkdir -p /mnt/efi
    $ mount </dev/efi_system_partition> /mnt/efi
    $ swapon </dev/swap_partition>
    ````
11. Install the following set of packages:
    1. essential packages: `base`, `linux`, `linux-firmware`
    2. utilities: `base-devel`, `sudo`, `git`, `zsh`, `openssh`, `reflector`
    3. CPU microcode updates: `intel-ucode`
    4. boot loader: `grub`, `efibootmgr`
    5. userspace utilities for file systems: `btrfs-progs`, `grub-btrfs`, `inotify-tools`, `timeshift`
    6. graphics firmware ([Intel Alder Lake](https://wiki.archlinux.org/title/Intel_graphics) and [NVIDIA Ampere](https://wiki.archlinux.org/title/NVIDIA)): `mesa`, `vulkan-intel`, `nvidia`, `nvidia-utils`, `nvidia-settings`
    7. audio firmware ([Dolby Atmos](https://wiki.archlinux.org/title/Lenovo_ThinkPad_T14_(AMD)_Gen_4#Speakers)): `pipewire`, `pipewire-alsa`, `pipewire-pulse`, `pipewire-jack`, `wireplumber`
    8. hardware management ([Lenovo Vantage](https://wiki.archlinux.org/title/Laptop/Lenovo#Lenovo)): `fwupd`, `tlp`
    9. software necessary for networking: `networkmanager`
    10. a console text editor: `vim`
    11. packages for accessing documentation: `man`

    Run the following command
    ````
    $ pacstrap -K /mnt <space separated list of packages>
    ````
    Creating a new `initramfs` will not be required, because `mkinitcpio` is run on installation of the kernel package with `pacstrap`. 
12. Configure the system.
    1. generate `fstab` file with startup instructions
        ````
        $ genfstab -U /mnt >> /mnt/etc/fstab
        $ cat /mnt/etc/fstab
        ````
    2. switch to new system's environment
        ````
        $ arch-chroot /mnt
        ````
    3. set up the time zone
        ````
        $ timedatectl status
        $ timedatectl list-timezones
        $ timedatectl set-timezone <Zone>/<SubZone>
        $ hwclock --systohc
        ````
    4. locale settings configuration
      1. Use `vim` to edit `/etc/locale.gen` and uncomment `en_US.UTF-8 UTF-8`.
      2. Generate the locales by running `locale-gen`
      3. Create configuration file `/etc/locale.conf` and use `vim` to write `LANG=en_US.UTF-8`.
    5. network configuration
      1. create  `/etc/hostname` and use `vim` to write `<PC-Name>` in the first line.
      2. Create `/etc/hosts` and use `vim` to add the following to it
          ````
          127.0.0.1 localhost
          ::1 localhost
          127.0.1.1 <PC-Name> 
          ````
    6. set root password using `passwd` command.
    7. add yourself as an admin user
        ````
        $ useradd -mG wheel <user-name>
        $ passwd <user-name>
        $ EDITOR=vim visudo
        ````
    The last command opens the `/etc/sudoers` file using `vim`; look for a line which says something like "Uncomment to let members of group wheel execute any action" and uncomment exactly the line BELOW it, by removing the `#`. This will grant superuser priviledges to your user.
    8. deploy and configure the boot loader
        ````
        $ grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id=GRUB
        $ grub-mkconfig -o /boot/grub/grub.cfg
        ````
13. Reboot
    1. verify that Direct Rendering Manager (DRM) is actually enabled for NVIDIA; the following command should return `Y`.
        ````
        $ cat /sys/module/nvidia_drm/parameters/modeset
        ````
    2. enable newtork manager
        ````
        $ systemctl enable NetworkManager
        ````
    3. Exit the chroot environment by typing `exit` or pressing <kbd>Ctrl</kbd> + <kbd>d</kbd>.
    4. manually unmount all the partitions
        ````
        $ umount -R /mnt
        ````
    5. Reboot the system and unplug the installation media
        ````
        $ reboot
        ````
14. login into the new system with the root account. 
