---
title: "I use Arch btw."
date: 2025-09-01
permalink: /posts/2025/09/arch/
tags:
  - linux
  - arch
  - thinkpad
---
Here is a documentation to get started with [the best operating system](https://wiki.archlinux.org/title/Arch_is_the_best).

I was introduced to Linux via [Canonical's advertisement program](https://ubuntu.com/blog/ubuntu-7-04-wins-a-100-best-products-of-2007-award-from-pc-world) that it ran with PCWorld magazine, in which the accompanying CD had latest Ubuntu version and other software updates. This led to Linux explorations (including weirdos like [BOSS Linux](https://distrowatch.com/table.php?distribution=BOSS), [Puppy Linux](https://distrowatch.com/table.php?distribution=puppy), [Peppermint](https://distrowatch.com/table.php?distribution=peppermint),...) in VirtualBox running on Windows XP. However, being unable to keep up with Microsoft Windows' increasing system requirements, I ended up using Lubuntu once Windows XP reached end of life. Since then, over the last 20 years, I have had the pleasure of working on the three major Linux distro families: `APT` (Debian/Ubuntu/Linux_Mint/Tuxedo_OS), `DNF` (Fedora/RHEL/CentOS), and `ZYpp` (SLE/openSUSE). You can read my long rants about various Linux distros in one of [my old blog post](https://gkorpal.github.io/posts/2020/08/distrohopping/). 

Over time, I have developed a sense of what I want and am ready to be responsible for my Thinkpad P16 :) 

I learned about the process from the [official guide](https://wiki.archlinux.org/title/Installation_guide) and supplemented it with the notes by [Michele Gementi](https://gist.github.com/mjkstra/96ce7a5689d753e7a6bdd92cdc169bae), [Max Pershin](https://github.com/silentz/arch-linux-install-guide), [Abhishek Prakash](https://itsfoss.com/install-arch-linux/), [quantinium](https://github.com/quantinium3/Guide-to-install-Arch-Linux), [Gentoo guide](https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks#Partitioning_the_disk_with_GPT_for_UEFI) and [Ubuntu guide](https://help.ubuntu.com/community/SwapFaq).

## Preparation

1. Download the latest `archlinux-YYYY.MM.DD-x86_64.iso`, `sha256sums.txt`, and `archlinux-YYYY.MM.DD-x86_64.iso.sig` from the [nearest mirror](https://archlinux.org/download/#download-mirrors) like `mirror.arizona.edu`.
2. Verify the integrity and authenticity of your ISO image using Linux (if Windows, use WSL). 
    1. Integrity: Ensure the download image matches the checksum from the `sha256sums.txt`
        ````
        $ sha256sum -c sha256sums.txt
        ````
        This should output `archlinux-YYYY.MM.DD-x86_64.iso: OK`. You may see "No such file or directory" for other files which we didn't download but their checksums also included.
    2. Authenticity: One should never use a GnuPG version just downloaded from internet to check the integrity; instead use an existing, trusted GnuPG installation, e.g., the one provided by your Linux distribution (if Windows, then use WSL).
        ````
        $ gpg --auto-key-locate clear,wkd -v --locate-external-key pierre@archlinux.org
        $ gpg --verify archlinux-YYYY.MM.DD-x86_64.iso.sig archlinux-YYYY.MM.DD-x86_64.iso
        ````
        GPG might give warning `This key is not certified with a trusted signature!`, but you can verify it [here](https://pierre-schmitz.com/gpg-keys/).
3. Create a bootable USB drive using [Ventoy](https://www.ventoy.net/en/download.html); remember to verify the checksum of Ventoy itself.
4. In BIOS, disable [secure boot](https://xkcd.com/1200/).
5. Check ArchLinux [website status](https://status.archlinux.org/) since they are prone to [DDoS attacks](https://lists.archlinux.org/archives/list/arch-general@lists.archlinux.org/thread/EU4NXRX6DDJAACOWIRZNU4S5KVXEUI72/). Also, the services may send an initial connection reset due to the TCP SYN authentication performed by the hosting provider, but subsequent requests should work as expected.
    1. In the case of downtime for `archlinux.org`:
        1. Mirrors: The mirror list endpoint used in tools like `reflector` is hosted on this site. Please default to the mirrors listed in the `pacman-mirrorlist` package during an outage.
        2. ISO: Installation image is available on a lot of the mirrors, for example the DevOps administered [geomirrors](https://geo.mirror.pkgbuild.com/iso/). Please always verify its integrity.
    2. In the case of downtime for `aur.archlinux.org`:
        1. Packages: A mirror of AUR packages is maintained on GitHub. You can retrieve a package using: 
            ````
            $ git clone --branch <package_name> --single-branch https://github.com/archlinux/aur.git <package_name>
            ```` 

## Filesystem, firmware, and local user

1. Boot from the USB drive and select Arch Linux to get logged in on the first virtual console as the root user, and presented with a Zsh shell prompt.
2. Verify that the boot mode is UEFI by ensuring that the following command returns 64.
    ````
    $ cat /sys/firmware/efi/fw_platform_size
    ````
3. Connect to WiFi using `iwctl`.
    ````
    $ iwctl
    [iwd]# device list
    [iwd]# station <device-name> scan
    [iwd]# station <device-name> get-networks
    [iwd]# station <device-name> connect <Name of WiFi access point>
    [iwd]# exit
    $ ping -c 5 ping.archlinux.org
    ````
4. Ensure that the system clock is syncronized via Network Time Protocol (NTP).
    ````
    $ systemctl enable systemd-timesyncd.service
    $ timedatectl
    ````
5. Use `cfdisk` to create the following GUID Partition Table (GPT), without hibernation feature (suspend-to-disk).
    | Mount point | Parition type | Size |
    | ----------- | ------------- | ---- |
    | `/efi`     |  EFI System Partition | 1 GiB |
    | `[swap]`    | Linux swap |  6 GiB |
    | `/`         | Linux Filesystem | (all of the remaining space ) |

    Can later get the partition names using `fdisk -l`.
6. Format the partitions using `mkfs`
    ````
    $ mkfs.btrfs </dev/root_partition>
    $ mkfs.fat -F 32 </dev/efi_system_partition>
    $ mkswap </dev/swap_partition>
    ````
7. Mount the file systems as we prepare to [chroot](https://wiki.archlinux.org/title/Chroot#Running_on_Btrfs).
    ````
    $ mount </dev/root_partition> /mnt
    $ btrfs subvolume create /mnt/@
    $ btrfs subvolume create /mnt/@home
    $ umount /mnt
    $ mount -o compress=zstd,subvol=@ </dev/root_partition> /mnt
    $ mkdir -p /mnt/home
    $ mount -o compress=zstd,subvol=@home </dev/root_partition> /mnt/home
    $ mkdir -p /mnt/efi
    $ mount </dev/efi_system_partition> /mnt/efi
    $ swapon </dev/swap_partition>
    ````
8. Install the following set of packages from the [official repositories](https://wiki.archlinux.org/title/Official_repositories):
    1. core packages: `base`, `linux`, `linux-firmware`
    2. utilities: `base-devel`, `sudo`, `git`, `openssh`, `reflector`
    3. CPU microcode updates: `intel-ucode`
    4. boot loader: `grub`, `efibootmgr`
    5. userspace utilities for file systems ([system restore](https://wiki.archlinux.org/title/Timeshift)): `btrfs-progs`, `timeshift`, `grub-btrfs`, `inotify-tools`, `xorg-xhost`
    6. device specific firmware
        1. graphics ([Intel Alder Lake](https://wiki.archlinux.org/title/Intel_graphics) and [NVIDIA Ampere](https://wiki.archlinux.org/title/NVIDIA)): `mesa`, `vulkan-intel`, `nvidia`, `nvidia-utils`, `nvidia-settings`
        2. audio ([Dolby Atmos](https://wiki.archlinux.org/title/Lenovo_ThinkPad_T14_(AMD)_Gen_4#Speakers)): `pipewire`, `pipewire-alsa`, `pipewire-pulse`, `pipewire-jack`, `wireplumber`
        3. resource management ([Lenovo Vantage](https://wiki.archlinux.org/title/Laptop/Lenovo#Lenovo)): `fwupd`, `tlp`
    7. networking software: `networkmanager`
    8. console text editor: `nano` 
    9. documentation: `man-pages`

    Run the following command
    ````
    $ pacstrap -K /mnt <space separated list of packages>
    ````
    Creating a new `initramfs` (*init*ial *RAM* *f*ile *s*ystem) will not be required, because `mkinitcpio` is run on installation of the kernel package with `pacstrap`. 
9. Configure the system.
    1. Generate `fstab` file with startup instructions
        ````
        $ genfstab -U /mnt >> /mnt/etc/fstab
        $ cat /mnt/etc/fstab
        ````
    2. Switch to new system's environment
        ````
        $ arch-chroot /mnt
        ````
    3. Set up the time zone
        ````
        $ ls /usr/share/zoneinfo/                                     
        $ ls /usr/share/zoneinfo/<Zone>/                              
        $ ln -sf /usr/share/zoneinfo/<Zone>/<Subzone> /etc/localtime       
        $ hwclock --systohc
        ````
    4. Locale settings configuration
        1. Use `nano` to edit `/etc/locale.gen` and uncomment `en_US.UTF-8 UTF-8`.
        2. Generate the locales by running `locale-gen` command.
        3. Create configuration file `/etc/locale.conf` and use `nano` to write `LANG=en_US.UTF-8`.
    5. Network configuration
        1. Create  `/etc/hostname` and use `nano` to write `<PC-Name>` in the first line.
        2. Create `/etc/hosts` and use `nano` to add the following to it
           ````
           127.0.0.1 localhost
           ::1 localhost
           127.0.1.1 <PC-Name> 
           ````
    6. Set root password using `passwd` command.
    7. Add yourself as an admin user
        ````
        $ useradd -mG wheel <user-name>
        $ passwd <user-name>
        $ EDITOR=nano visudo
        ````
        The [last command](https://wiki.archlinux.org/title/Sudo#Using_visudo) opens the `/etc/sudoers` file using `nano`; look for a line which says something like "Uncomment to let members of group wheel execute any action" and uncomment exactly the line BELOW it, by removing the `#`. This will grant superuser priviledges to your user.
    8. Deploy and configure the boot loader.
        ````
        $ grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id=GRUB
        $ grub-mkconfig -o /boot/grub/grub.cfg
        ````
    9. Enable network manager to run on boot.
        ````
        $ systemctl enable NetworkManager
        ````
    10. Exit the chroot environment by typing `exit` or pressing <kbd>Ctrl</kbd> + <kbd>d</kbd>.
10. Manually unmount all the partitions
    ````
    $ umount -R /mnt
    ````
11. Reboot the system and remove the installation media
    ````
    $ reboot
    ````

## Userspace configuration 

1. Log into the user account `<user-name>`.
2. Connect to WiFi using `nmtui` or `nmcli`.
    ````
    $ nmcli device wifi connect <Name of WiFi access point> password <password>
    ````
3. Activate time syncronization using NTP.
    ````
    $ timedatectl set-ntp true
    ````
4. Add snapshots to the GRUB menu each time GRUB configuration is generated [using `grub-btrfs`](https://wiki.archlinux.org/title/Timeshift#GRUB_entries_for_btrfs_snapshots). 
    ````
    $ sudo systemctl edit --full grub-btrfsd
    $ sudo systemctl enable grub-btrfsd
    ````
    Replace `ExecStart=...` with `ExecStart=/usr/bin/grub-btrfsd --syslog --timeshift-auto`. A bug that can bite https://github.com/Antynea/grub-btrfs/issues/344
8. Enable TLP to run on boot.
    ````
    $ systemctl enable tlp.service
    ````
   You can configure `tlp` by editing [battery care settings](https://linrunner.de/tlp/settings/bc-vendors.html) in `/etc/tlp.conf`.
9. Install KDE with [Wayland support](https://archlinux.org/news/plasma-640-will-need-manual-intervention-if-you-are-on-x11/) following advice from the [KDE documentation](https://community.kde.org/Distributions/Packaging_Recommendations) and Arch dependency tree of [`plasma-desktop`](https://archlinux.org/packages/extra/x86_64/plasma-desktop/).
    1. base: `plasma-{desktop,pa,nm,systemmonitor,firewall}`, `kscreen`, `bluedevil`
    2. keyring ([Pluggable Authentication Modules](https://wiki.archlinux.org/title/KDE_Wallet#Unlock_KDE_Wallet_automatically_on_login)): `kwalletmanager`, `kwallet-pam`
    3. terminal (otherwise will need to use [`tty`](https://wiki.archlinux.org/title/Linux_console)): `konsole`
    4. file manager: `dolphin`, `dolphin-plugins`, `kdegraphics-thumbnailers`, `ffmpegthumbs`
    5. XDG Desktop Portal ([Wayland and Firefox integration](https://wiki.archlinux.org/title/XDG_Desktop_Portal)): `xdg-desktop-portal-gtk`, `xdg-desktop-portal-kde`
    6. Theme consistency ([GTK in Qt](https://wiki.archlinux.org/title/Uniform_look_for_Qt_and_GTK_applications#Styles_for_both_Qt_and_GTK)): `breeze-gtk`, `kde-gtk-config`
    
    ````
    $ sudo pacman -S   <space separated list of packages>    
    ````
    You may be prompted to choose between [`ffmpeg`](https://archlinux.org/packages/extra/x86_64/qt6-multimedia-ffmpeg/) or [`gstreamer`](https://archlinux.org/packages/extra/x86_64/qt6-multimedia-gstreamer/) backend for `qt6-multimedia`. I chose `ffmpeg` because that [seems to be the default](https://code.qt.io/cgit/qt/qtmultimedia.git/commit/?id=5a5fc56e06500c427f4db8666aa103151748588e).
   
    We have consciously excluded `discover` from KDE because is can lead to partial upgrades [which are unsupported in Arch](https://wiki.archlinux.org/title/System_maintenance#Partial_upgrades_are_unsupported).
10. Install Simple Desktop Display Manager (SDDM).
    ````
    $ sudo pacman -S sddm
    $ sudo systemctl enable sddm
    $ sudo pacman -S --needed sddm-kcm
    ````
11. Reboot to finalize installation.
    ````
    $ reboot
    ````
    
## Initial setup

1. Login using SDDM.
2. Go to `Settings` &rarr; `Colors & Themes` &rarr; `Login Screen (SDDM)` &rarr; `Breeze` &rarr; `Change Background` &rarr; `Apply`.
3. Snapshots can be managed through the `timeshift-gtk` graphical user interface, as well as the `timeshift` command-line user interface tool. Set up thimeshift. Exclude `@home` subvolume from snapshots. Schedule regular snapshots. Not using [`timeshift-autosnap`](https://aur.archlinux.org/packages/timeshift-autosnap) because I got biten by [a bug](https://github.com/Antynea/grub-btrfs/issues/288) where it interferes with `grub-btrfsd` action. Moreover, I want to avoid depending on [AUR](https://wiki.archlinux.org/title/Arch_User_Repository) whenever possible. 
    Instead run 
    ````
    $ timeshift --create --comments "comment"
    ````
    before each upgrade.
4. Check TLP status
    ````
    $ sudo tlp-stat -s
    $ sudo tlp-stat -b
    ````
5. backup on cloud using rclone
6. Reboot and check if things if the things are as expected.

## Maintainance

full upgrade: pacman -Syu

Before we begin, 
https://en.wikipedia.org/wiki/Package_manager#Comparison_of_commands

Pacman: https://wiki.archlinux.org/title/Pacman/Rosetta

Pacman queries the local package database with the `-Q` flag, the sync database with the `-S` flag and the files database with the `-F` flag.

pacman is short for package manager.

https://www.reddit.com/r/linux4noobs/comments/xin1zo/why_do_package_managers_have_such_difficult_names/

https://pkgstats.archlinux.de/fun

1. Installed from official repositories using `pacman`.
    1. Browser: `firefox` (along with extensions: uBlock Origin, Privacy Badger, Decentraleyes, ClearURLs, and password manager) 
    2. Document viewer: `okular`, `ebook-tools`, `kdegraphics-mobipocket`, `unarchiver`
    3. Image viewer: `gwenview`, `kimageformats`, `qt6-imageformats`
    4. Video player ([mpv](https://wiki.archlinux.org/title/Mpv) based): `haruna`, `yt-dlp`
    5. Archiving tool: `ark`, `7zip`
    6. Screenshot tool: `spectacle`
    7. Calculator: `kalk`
    8. Text editor: `kate`
    9. File searching tool: `kfind`
    10. Messaging: `signal-desktop`
    12. Webcam controls ([LogiTune](https://wiki.archlinux.org/title/Webcam_setup#Graphical)): `cameractrls`
    13. Wireless mouse ([LogiBolt](https://wiki.archlinux.org/title/Logitech_Unifying_Receiver)): `solaar`

boot from a snapshot if something goes wrong. 
https://wiki.archlinux.org/title/Btrfs#Booting_into_snapshots

https://wiki.archlinux.org/title/General_troubleshooting

https://wiki.archlinux.org/title/Downgrading_packages

https://www.reddit.com/r/archlinux/comments/n1zw5s/what_are_some_aur_packages_that_are_a_musthave_in/

https://wiki.archlinux.org/title/System_maintenance

https://github.com/Antynea/grub-btrfs

https://bbs.archlinux.org/viewtopic.php?id=297446

