---
title: "Arch Linux on Thinkpad P16"
date: 2022-07-01
permalink: /posts/2025/09/arch/
tags:
  - linux
  - arch
  - thinkpad
---

During my PhD I had to resort to using WSL because university required Microsoft and Adobe software. However, WSL is wasteful because of the useless Windows host that is garbage (eg. [secure boot charade](), [app ads](https://www.theverge.com/2024/4/24/24138949/microsoft-windows-11-start-menu-ads-recommendations-setting-disable), [bloatware](https://www.pdq.com/blog/how-to-remove-bloatware/),... ). Microsoft Windows is as bad as Google Android. Even in the stock version they invade your privacy. On top of that, GitHub uses our code to train AI to replace us. At least, Google Drive is a better product than Microsoft Onedrive though both are dubious. 

I want full control over my $1900 Thinkpad workstation.

## Installation steps

I learned about the process from the [official guide](https://wiki.archlinux.org/title/Installation_guide) and supplemented it with the notes by [Michele Gementi](https://gist.github.com/mjkstra/96ce7a5689d753e7a6bdd92cdc169bae), [Max Pershin](https://github.com/silentz/arch-linux-install-guide), [Abhishek Prakash](https://itsfoss.com/install-arch-linux/), [quantinium](https://github.com/quantinium3/Guide-to-install-Arch-Linux), [Gentoo guide](https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks#Partitioning_the_disk_with_GPT_for_UEFI) and [Ubuntu guide](https://help.ubuntu.com/community/SwapFaq).

1. Download the latest `archlinux-YYYY.MM.DD-x86_64.iso`, `sha256sums.txt`, and `archlinux-YYYY.MM.DD-x86_64.iso.sig` from the [nearest mirror](https://archlinux.org/download/#download-mirrors) like `mirror.arizona.edu`.
2. Verify the integrity and authenticity of your ISO image using Linux (if Windows, use WSL). 
    1. Integrity: Ensure the download image matches the checksum from the `sha256sums.txt`
        ````
        $ sha256sum -c sha256sums.txt
        ````
        This should output `archlinux-YYYY.MM.DD-x86_64.iso: OK`. You may see "No such file or directory" for other files which we didn't download but their checksums also included.
    2. Authenticity: One should never use a GnuPG version just downloaded from internet to check the integrity; instead use an existing, trusted GnuPG installation, e.g., the one provided by your Linux distribution (if Windows, then use WSL).
        ````
        $ gpg --auto-key-locate clear,wkd -v --locate-external-key pierre@archlinux.org
        $ gpg --verify archlinux-YYYY.MM.DD-x86_64.iso.sig archlinux-YYYY.MM.DD-x86_64.iso
        ````
        GPG might warn `This key is not certified with a trusted signature!`. This is expected and perfectly normal.
3. Create a bootable USB drive using [Ventoy](https://www.ventoy.net/en/doc_start.html).
4. In BIOS, disable [secure boot](https://xkcd.com/1200/).
5. Check ArchLinux [website status](https://status.archlinux.org/) since they are prone to [DDoS attacks](https://lists.archlinux.org/archives/list/arch-general@lists.archlinux.org/thread/EU4NXRX6DDJAACOWIRZNU4S5KVXEUI72/). Also, the services may send an initial connection reset due to the TCP SYN authentication performed by the hosting provider, but subsequent requests should work as expected.
    1. In the case of downtime for `archlinux.org`:
        1. Mirrors: The mirror list endpoint used in tools like `reflector` is hosted on this site. Please default to the mirrors listed in the `pacman-mirrorlist` package during an outage.
        2. ISO: Installation image is available on a lot of the mirrors, for example the DevOps administered [geomirrors](https://geo.mirror.pkgbuild.com/iso/). Please always verify its integrity.
    2. In the case of downtime for `aur.archlinux.org`:
        1. Packages: A mirror of AUR packages is maintained on GitHub. You can retrieve a package using: 
            ````
            $ git clone --branch <package_name> --single-branch https://github.com/archlinux/aur.git <package_name>
            ```` 
6. Boot from the USB drive and select Arch Linux. Will get logged in on the first virtual console as the root user, and presented with a Zsh shell prompt.
7. Verify that the boot mode is UEFI by ensuring that the following command returns 64.
    ````
    $ cat /sys/firmware/efi/fw_platform_size
    ````
8. Connect to WiFi using `iwctl`.
    ````
    $ iwctl
    [iwd]# device list
    [iwd]# station <device-name> scan
    [iwd]# station <device-name> get-networks
    [iwd]# station <device-name> connect <Name of WiFi access point>
    [iwd]# exit
    $ ping -c 5 ping.archlinux.org
    ````
9. Ensure that the system clock is syncronized via Network Time Protocol (NTP).
    ````
    $ systemctl enable systemd-timesyncd.service
    $ timedatectl
    ````
10. Use `cfdisk` to create the following GUID Partition Table (GPT), without hibernation feature (suspend-to-disk).
    | Mount point | Parition type | Size |
    | ----------- | ------------- | ---- |
    | `/efi`     |  EFI System Partition | 1 GiB |
    | `[swap]`    | Linux swap |  6 GiB |
    | `/`         | Linux Filesystem | (all of the remaining space ) |
11. Format the partitions using `mkfs`
    ````
    $ mkfs.btrfs </dev/root_partition>
    $ mkfs.fat -F 32 </dev/efi_system_partition>
    $ mkswap </dev/swap_partition>
    ````
12. Mount the file systems
    ````
    $ mount </dev/root_partition> /mnt
    $ btrfs subvolume create /mnt/@
    $ btrfs subvolume create /mnt/@home
    $ umount /mnt
    $ mount -o compress=zstd,subvol=@ </dev/root_partition> /mnt
    $ mkdir -p /mnt/home
    $ mount -o compress=zstd,subvol=@home </dev/root_partition> /mnt/home
    $ mkdir -p /mnt/efi
    $ mount </dev/efi_system_partition> /mnt/efi
    $ swapon </dev/swap_partition>
    ````
13. Install the following set of packages:
    1. essential packages: `base`, `linux`, `linux-firmware`
    2. utilities: `base-devel`, `sudo`, `git`, `zsh`, `openssh`, `reflector`
    3. CPU microcode updates: `intel-ucode`
    4. boot loader: `grub`, `efibootmgr`
    5. userspace utilities for file systems: `btrfs-progs`, `grub-btrfs`, `inotify-tools`, `timeshift`
    6. graphics firmware ([Intel Alder Lake](https://wiki.archlinux.org/title/Intel_graphics) and [NVIDIA Ampere](https://wiki.archlinux.org/title/NVIDIA)): `mesa`, `vulkan-intel`, `nvidia`, `nvidia-utils`, `nvidia-settings`
    7. audio firmware ([Dolby Atmos](https://wiki.archlinux.org/title/Lenovo_ThinkPad_T14_(AMD)_Gen_4#Speakers)): `pipewire`, `pipewire-alsa`, `pipewire-pulse`, `pipewire-jack`, `wireplumber`
    8. hardware management ([Lenovo Vantage](https://wiki.archlinux.org/title/Laptop/Lenovo#Lenovo)): `fwupd`, `tlp`
    9. software necessary for networking: `networkmanager`
    10. a console text editor: `vim`
    11. packages for accessing documentation: `man`

    Run the following command
    ````
    $ pacstrap -K /mnt <space separated list of packages>
    ````
    Creating a new `initramfs` will not be required, because `mkinitcpio` is run on installation of the kernel package with `pacstrap`. 
14. Configure the system.
    1. generate `fstab` file with startup instructions
        ````
        $ genfstab -U /mnt >> /mnt/etc/fstab
        $ cat /mnt/etc/fstab
        ````
    2. switch to new system's environment
        ````
        $ arch-chroot /mnt
        ````
    3. set up the time zone
        ````
        $ timedatectl status
        $ timedatectl list-timezones
        $ timedatectl set-timezone <Zone>/<SubZone>
        $ hwclock --systohc
        ````
    4. locale settings configuration
      1. Use `vim` to edit `/etc/locale.gen` and uncomment `en_US.UTF-8 UTF-8`.
      2. Generate the locales by running `locale-gen`
      3. Create configuration file `/etc/locale.conf` and use `vim` to write `LANG=en_US.UTF-8`.
    5. network configuration
      1. create  `/etc/hostname` and use `vim` to write `<PC-Name>` in the first line.
      2. Create `/etc/hosts` and use `vim` to add the following to it
          ````
          127.0.0.1 localhost
          ::1 localhost
          127.0.1.1 <PC-Name> 
          ````
    6. set root password using `passwd` command.
    7. add yourself as an admin user
        ````
        $ useradd -mG wheel <user-name>
        $ passwd <user-name>
        $ EDITOR=vim visudo
        ````
        The last command opens the `/etc/sudoers` file using `vim`; look for a line which says something like "Uncomment to let members of group wheel execute any action" and uncomment exactly the line BELOW it, by removing the `#`. This will grant superuser priviledges to your user.
    8. deploy and configure the boot loader
        ````
        $ grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id=GRUB
        $ grub-mkconfig -o /boot/grub/grub.cfg
        ````
    9. verify that Direct Rendering Manager (DRM) is actually enabled for NVIDIA; the following command should return `Y`.
        ````
        $ cat /sys/module/nvidia_drm/parameters/modeset
        ````
    10. enable newtork manager to run on boot
        ````
        $ systemctl enable NetworkManager
        ````
    11. enable TLP to run on boot
        ````
        $ systemctl enable tlp
        ````
    12. Exit the chroot environment by typing `exit` or pressing <kbd>Ctrl</kbd> + <kbd>d</kbd>.
    13. manually unmount all the partitions
        ````
        $ umount -R /mnt
        ````
    14. Reboot the system and unplug the installation media
        ````
        $ reboot
        ````
15. Log into the user account `<user-name>` and configure the userspace.
    1. Connect to WiFi using `nmtui` or `nmcli`:
        ````
        $ nmcli device wifi connect <Name of WiFi access point> password <password>
        ````
    2. Activate time syncronization using NTP
        ````
        $ timedatectl set-ntp true
        ````
    3. Automatic snapshot boot entries update
        ````
        $ sudo systemctl edit --full grub-btrfsd
        $ sudo systemctl enable grub-btrfsd
        ````
    4. Install package manager `yay` for AUR (Arch User Repository)
        ````
        $ sudo pacman -S --needed git base-devel && git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si
        ````
    5. Install `timeshift-autosnap` which automatically makes snapshots before pacman upgrades.
        ````
        $ yay -S timeshift-autosnap
        ````
    6. Reboot to finalize installation.
        ````
        $ reboot
        ````


  https://wiki.archlinux.org/title/PRIME#NVIDIA
  https://wiki.archlinux.org/title/NVIDIA_Optimus#SDDM
