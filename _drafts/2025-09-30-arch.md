---
title: "I use Arch btw."
date: 2025-09-30
permalink: /posts/2025/09/arch/
tags:
  - linux
  - arch
  - thinkpad
  - grub
  - btrfs
  - snapper
  - rclone
---
Here is a documentation to get started with [the best operating system](https://wiki.archlinux.org/title/Arch_is_the_best).

I was introduced to Linux via [Canonical's advertisement program](https://ubuntu.com/blog/ubuntu-7-04-wins-a-100-best-products-of-2007-award-from-pc-world) that it ran with PCWorld magazine, in which the accompanying CD had latest Ubuntu version and other software updates. This led to Linux explorations (including weirdos like [BOSS Linux](https://distrowatch.com/table.php?distribution=BOSS), [Puppy Linux](https://distrowatch.com/table.php?distribution=puppy), [Peppermint](https://distrowatch.com/table.php?distribution=peppermint),...) in VirtualBox running on Windows XP. However, being unable to keep up with Microsoft Windows' increasing system requirements, I ended up using Lubuntu once Windows XP reached end of life. Since then, over the last 20 years, I have had the pleasure of working on the three major Linux distro families: `APT` (Debian/Ubuntu/Linux_Mint/Tuxedo_OS/Kali_Linux), `DNF` (Fedora/RHEL/CentOS), and `ZYpp` (SLE/openSUSE). You can read my long rants about various Linux distros in one of [my old blog post](https://gkorpal.github.io/posts/2020/08/distrohopping/). 

Over time, I have developed a sense of what I want and am ready to be responsible for my Thinkpad P16 :) Long term Linux users might enjoy this [comparison of Arch with other distros](https://wiki.archlinux.org/title/Arch_compared_to_other_distributions).

I learned about the process from the [official guide](https://wiki.archlinux.org/title/Installation_guide) and supplemented it with the notes by [Michele Gementi](https://gist.github.com/mjkstra/96ce7a5689d753e7a6bdd92cdc169bae), [Max Pershin](https://github.com/silentz/arch-linux-install-guide), [Abhishek Prakash](https://itsfoss.com/install-arch-linux/), [quantinium](https://github.com/quantinium3/Guide-to-install-Arch-Linux), [Daniel Wayne Armstrong](https://www.dwarmstrong.org/btrfs-snapshots-rollbacks/), [Gentoo](https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks#Partitioning_the_disk_with_GPT_for_UEFI) and [Ubuntu](https://help.ubuntu.com/community/SwapFaq).

I will follow the [Arch Wiki convention](https://wiki.archlinux.org/title/Help:Reading): The numeral or hash sign (`#`) indicates that the command needs to be run as *root*, whereas the dollar sign (`$`) shows that the command should be run as a *regular user*. 

## Prepararation

1. Check ArchLinux [website status](https://status.archlinux.org/) since they are prone to [DDoS attacks](https://lists.archlinux.org/archives/list/arch-general@lists.archlinux.org/thread/EU4NXRX6DDJAACOWIRZNU4S5KVXEUI72/). Also, the services may send an initial connection reset due to the TCP SYN authentication performed by the hosting provider, but subsequent requests should work as expected.
    1. In the case of downtime for `archlinux.org`:
        1. Mirrors: The mirror list endpoint used in tools like `reflector` is hosted on this site. Please default to the mirrors listed in the `pacman-mirrorlist` package during an outage.
        2. ISO: Installation image is available on a lot of the mirrors, for example the DevOps administered [geomirrors](https://geo.mirror.pkgbuild.com/iso/). Please always verify its integrity.
    2. In the case of downtime for `aur.archlinux.org`:
        1. Packages: A mirror of AUR packages is maintained on GitHub. You can retrieve a package using: 
            ````
            $ git clone --branch <package_name> --single-branch https://github.com/archlinux/aur.git <package_name>
            ```` 
2. Download the latest `archlinux-YYYY.MM.DD-x86_64.iso`, `sha256sums.txt`, and `archlinux-YYYY.MM.DD-x86_64.iso.sig` from the [nearest mirror](https://archlinux.org/download/#download-mirrors) like `mirror.arizona.edu`.
3. Verify the integrity and authenticity of your ISO image using Linux (if Windows, use WSL). 
    1. Integrity: Ensure the download image matches the checksum from the `sha256sums.txt`
        ````
        $ sha256sum -c sha256sums.txt
        ````
        This should output `archlinux-YYYY.MM.DD-x86_64.iso: OK`. You may see "No such file or directory" for other files which we didn't download but their checksums also included.
    2. Authenticity: One should never use a GnuPG version just downloaded from internet to check the integrity; instead use an existing, trusted GnuPG installation, e.g., the one provided by your Linux distribution (if Windows, then use WSL).
        ````
        $ gpg --auto-key-locate clear,wkd -v --locate-external-key pierre@archlinux.org
        $ gpg --verify archlinux-YYYY.MM.DD-x86_64.iso.sig archlinux-YYYY.MM.DD-x86_64.iso
        ````
        GPG might give warning `This key is not certified with a trusted signature!`, but you can verify it [here](https://pierre-schmitz.com/gpg-keys/).
4. Create a bootable USB drive using [Ventoy](https://www.ventoy.net/en/download.html); remember to verify the checksum of Ventoy itself.
5. In UEFI, disable [secure boot](https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot).

## From chroot to root

1. Boot from the Live USB drive and select Arch Linux from [the `systemd-boot` greeting screen](https://wiki.archlinux.org/title/Installation_guide#Boot_the_live_environment) to get logged in on the first virtual console as the root user, and presented with a Zsh shell prompt.
2. Verify that the boot mode is UEFI by ensuring that the following command returns 64.
    ````
    # cat /sys/firmware/efi/fw_platform_size
    ````
3. Connect to WiFi using `iwctl`.
    ````
    # iwctl
    [iwd]# device list
    [iwd]# station <device-name> scan
    [iwd]# station <device-name> get-networks
    [iwd]# station <device-name> connect <Name of WiFi access point>
    [iwd]# exit
    $ ping -c 5 ping.archlinux.org
    ````
4. Ensure that the system clock is syncronized via Network Time Protocol (NTP).
    ````
    # timedatectl set-ntp true
    ````
5. Use `cfdisk` to create the following GUID Partition Table (GPT), without hibernation feature (suspend-to-disk).
    | Mount point | Parition type | Size | Partition |
    | ----------- | ------------- | ---- | -------- |
    | `/efi`     |  EFI System Partition | 1 GiB | `/dev/efi_system_partition` |
    | `[swap]`    | Linux swap |  6 GiB | `/dev/swap_partition` |
    | `/`         | Linux Filesystem | (all of the remaining space ) | `/dev/root_partition` |

    Can later get the partition names using `fdisk -l`. 
6. Format the partitions using `mkfs`.
    ````
    # mkfs.fat -F 32 /dev/efi_system_partition
    # mkswap /dev/swap_partition
    # mkfs.btrfs /dev/root_partition
    ````
7. Create the Btrfs filesystem layout [recommended for `snapper`](https://wiki.archlinux.org/title/Snapper#Suggested_filesystem_layout) 
    ````
    # mount /dev/root_partition /mnt
    # btrfs subvolume create /mnt/@
    # btrfs subvolume create /mnt/@home
    # btrfs subvolume create /mnt/@var_log
    # btrfs subvolume create /mnt/@var_cache
    # btrfs subvolume create /mnt/@var_spool
    # btrfs subvolume create /mnt/@var_tmp
    # btrfs subvolume create /mnt/@snapshots
    # umount /mnt
    ````
8. Mount the file systems as we prepare to [chroot](https://wiki.archlinux.org/title/Chroot#Running_on_Btrfs) with [Btrfs compression settings](https://btrfs.readthedocs.io/en/latest/Administration.html#notes-on-generic-mount-options) optimized for NVMe SSD (Kioxia XG8) and not using [Mutt](https://wiki.archlinux.org/title/Mutt).
    ````
    # mount -o noatime,compress=zstd:1,subvol=@ /dev/root_partition /mnt
    # mkdir -p /mnt/{home,var/log,var/cache,var/spool,var/tmp,.snapshots}
    # mount -o noatime,compress=zstd:1,subvol=@home /dev/root_partition /mnt/home
    # mount -o noatime,compress=zstd:1,subvol=@var_log /dev/root_partition /mnt/var/log
    # mount -o noatime,compress=zstd:1,subvol=@var_cache /dev/root_partition /mnt/var/cache
    # mount -o noatime,compress=zstd:1,subvol=@var_spool /dev/root_partition /mnt/var/spool
    # mount -o noatime,compress=zstd:1,subvol=@var_tmp /dev/root_partition /mnt/var/tmp
    # mount -o noatime,compress=zstd:1,subvol=@snapshots /dev/root_partition /mnt/.snapshots
    # mount --mkdir /dev/efi_system_partition /mnt/efi
    # swapon /dev/swap_partition
    ````
9. Use [`pacstrap`](https://man.archlinux.org/man/pacstrap.8) to create a new system installation from scratch.
    ````
    # pacstrap -K /mnt
    ````
    This installs the [`base` metapackage](https://archlinux.org/packages/core/any/base/) consisting of basic tools like [`bash`](https://wiki.archlinux.org/title/Bash), [`systemd`](https://wiki.archlinux.org/title/Systemd), and [`pacman`](https://wiki.archlinux.org/title/Pacman).
10. Generate [`fstab`](https://wiki.archlinux.org/title/Fstab) file with startup instructions
    ````
    # genfstab -U /mnt >> /mnt/etc/fstab
    ````
    Check the resulting `/mnt/etc/fstab` file, and edit it in case of errors. 
11. Switch to the new system's environment
    ````
    # arch-chroot /mnt
    ````
    1. Set up the [time zone](https://wiki.archlinux.org/title/System_time).
        ````
        # ls /usr/share/zoneinfo/                                     
        # ls /usr/share/zoneinfo/<Zone>/                              
        # ln -sf /usr/share/zoneinfo/<Zone>/<Subzone> /etc/localtime       
        # hwclock --systohc
        ````
    2. Configure correct region and language specific formatting.
        1. Install a console text-editors like [`nano`](https://wiki.archlinux.org/title/Nano):
           ````
           # pacman -S nano
           ````
        2. Use `nano` to edit `/etc/locale.gen` and uncomment `en_US.UTF-8 UTF-8`.
        3. Generate the locales.
           ````
           # locale-gen
           ````
        4. Use `nano` to create configuration file `/etc/locale.conf` and write `LANG=en_US.UTF-8` in it.
    3. Network configuration.
        1. Use `nano` to create  `/etc/hostname` and write `<PC-Name>` in it.
        2. Use `nano` to edit `/etc/hosts` and add the following to it
           ````
           127.0.0.1 localhost
           ::1 localhost
           127.0.1.1 <PC-Name> 
           ````
        3. Install and enable [network manager](https://wiki.archlinux.org/title/NetworkManager) to run on boot.
           ````
           # pacman -S networkmanager
           # systemctl enable NetworkManager
           ````
    4.  Create a new `initramfs` (*init*ial *RAM* *f*ile *s*ystem)
        1. Install [Linux kernel](https://wiki.archlinux.org/title/Kernel) `linux` with `linux-lts` as a [fallback option](https://wiki.archlinux.org/title/System_maintenance#Install_the_linux-lts_package).
        2. Install [kernel firmware](https://wiki.archlinux.org/title/Linux_firmware) (`linux-firmware`) along with additional firmware for [Intel CPU](https://wiki.archlinux.org/title/Microcode) (`intel-ucode`), [Intel iGPU](https://wiki.archlinux.org/title/Intel_graphics) (`mesa`, `vulkan-intel`), [NVIDIA dGPU](https://wiki.archlinux.org/title/NVIDIA) (`nvidia`, `nvidia-utils`), and [Dolby Atmos](https://gitlab.freedesktop.org/pipewire/pipewire/-/wikis/Filter-Chain#virtual-surround) (`pipewire`, `pipewire-alsa`, `pipewire-pulse`, `pipewire-jack`, `wireplumber`). 
           ````
           # pacman -S linux-firmware intel-ucode mesa vulkan-intel nvidia nvidia-utils pipewire pipewire-{alsa,pulse,jack} wireplumber
           ````
        3. Run [`mkinitcpio`](https://man.archlinux.org/man/mkinitcpio.8) to create an initial ramdisk environment.
           ````
           # mkinitcpio -P
           ````
           Note that every time a kernel is installed or upgraded, a pacman hook automatically generates a preset file saved in `/etc/mkinitcpio.d/` and `-P` option process all presets contained in `/etc/mkinitcpio.d`. 
    6. Set root password using `passwd` command.
    7. Install a [btrfs-friendly bootloader](https://btrfs.readthedocs.io/en/latest/Administration.html#bootloaders), like [GRUB](https://wiki.archlinux.org/title/GRUB).
        ````
        # pacman -S grub efibootmgr
        # grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id=GRUB
        # grub-mkconfig -o /boot/grub/grub.cfg
        ````
        Kernel packages are installed under the `/usr/lib/modules/` path and subsequently used to copy the vmlinuz executable image to `/boot/`. We can use the bootloader to switch between `linux` and `linux-lts` kernel.
    10. Exit the chroot environment by typing `exit` or pressing <kbd>Ctrl</kbd> + <kbd>d</kbd>.
11. Manually unmount all the partitions
    ````
    # umount -R /mnt
    ````
12. Reboot the system and remove the installation media
    ````
    # reboot
    ````

## From superuser to user

1. Login into the new system with the root account (superuser).
2. Connect to WiFi using `nmtui` or `nmcli`.
    ````
    # nmcli device wifi connect <Name of WiFi access point> password <password>
    ````
3. Install `man` to have offline access to [Arch Linx documentation](https://wiki.archlinux.org/title/Man_page).
    ````
    # pacman -S man-db
    ````
4. Mimic [Lenovo Vantage](https://wiki.archlinux.org/title/Laptop/Lenovo) to manage UEFI updates and battery control using `fwupd` and `tlp`.
   ````
   # pacman -S fwupd tlp
   # fwupdmgr get-devices
   # systemctl enable --now tlp.service
   # tlp-stat -s
   # tlp-stat -b
   ````
   We can configure `tlp` by editing [battery care settings](https://linrunner.de/tlp/settings/bc-vendors.html) in `/etc/tlp.conf`.
5. Create a user and add to [administration group](https://wiki.archlinux.org/title/Users_and_groups) (`wheel`) with [`sudo`](https://man.archlinux.org/man/sudo.8) access. Note that logging in using root account is [disabled for GUI](https://bbs.archlinux.org/viewtopic.php?id=110630).
     ````
     # useradd -mG wheel <user-name>
     # passwd <user-name>
     # pacman -S sudo
     # EDITOR=nano visudo
     ````
     The [last command](https://wiki.archlinux.org/title/Sudo#Using_visudo) opens the `/etc/sudoers` file using `nano`; look for a line which says something like `Uncomment to allow members of group wheel to execute any command` and uncomment exactly the line BELOW it, by removing the `#`. This will grant superuser priviledges to your user.
6. Check [NVIDIA configuration](https://wiki.archlinux.org/title/NVIDIA#Wayland_configuration) by ensuring that the Direct Rendering Manager (DRM) is enabled.
    ````
    # cat /sys/module/nvidia_drm/parameters/modeset
    ````
    This should return `Y`. 
7. Install KDE with [Wayland support](https://archlinux.org/news/plasma-640-will-need-manual-intervention-if-you-are-on-x11/) following advice from the [KDE documentation](https://community.kde.org/Distributions/Packaging_Recommendations) and Arch dependency tree of [`plasma-desktop`](https://archlinux.org/packages/extra/x86_64/plasma-desktop/). We have consciously excluded `discover` from KDE because it can lead to partial upgrades [which are unsupported in Arch](https://wiki.archlinux.org/title/System_maintenance#Partial_upgrades_are_unsupported).
    1. base: `plasma-{desktop,pa,nm,systemmonitor,firewall}`, `kscreen`, `bluedevil`, `nvidia-settings`
    2. keyring ([PAM](https://wiki.archlinux.org/title/KDE_Wallet#Unlock_KDE_Wallet_automatically_on_login)): `kwalletmanager`, `kwallet-pam`
    3. terminal (otherwise will need to use [`tty`](https://wiki.archlinux.org/title/Linux_console)): `konsole`
    4. file manager: `dolphin`, `dolphin-plugins`, `kdegraphics-thumbnailers`, `ffmpegthumbs`
    5. XDG Desktop Portal ([Wayland and Firefox integration](https://wiki.archlinux.org/title/XDG_Desktop_Portal)): `xdg-desktop-portal-gtk`, `xdg-desktop-portal-kde`
    6. Theme consistency ([GTK in Qt](https://wiki.archlinux.org/title/Uniform_look_for_Qt_and_GTK_applications#Styles_for_both_Qt_and_GTK)): `breeze-gtk`, `kde-gtk-config`
    ````
    # pacman -S <space separated list of packages>    
    ````
    You may be prompted to choose between [`ffmpeg`](https://archlinux.org/packages/extra/x86_64/qt6-multimedia-ffmpeg/) or [`gstreamer`](https://archlinux.org/packages/extra/x86_64/qt6-multimedia-gstreamer/) backend for `qt6-multimedia`. I chose `ffmpeg` because that [seems to be the default](https://code.qt.io/cgit/qt/qtmultimedia.git/commit/?id=5a5fc56e06500c427f4db8666aa103151748588e).
8. Install Simple Desktop Display Manager (SDDM).
    ````
    $ sudo pacman -S sddm
    $ sudo systemctl enable sddm
    $ sudo pacman -S --needed sddm-kcm
    ````
9. Reboot to finalize installation.
    ````
    # reboot
    ````
    
## Personalization

1. Login using user account in SDDM.
2. Check if any systemd services have failed or errors in the log files located in `/var/log/`.
    ````
    $ systemctl --failed
    $ journalctl -b -p 3
    ````
3. Go to `Settings` &rarr; `Colors & Themes` &rarr; `Login Screen (SDDM)` &rarr; `Breeze` &rarr; `Change Background` &rarr; `Apply`.
4. Install [essential software](https://pkgstats.archlinux.de/fun) using the [package manager](https://wiki.archlinux.org/title/Pacman). 
    1. Browser: `firefox` (along with extensions: uBlock Origin, Privacy Badger, Decentraleyes, ClearURLs, and password manager) 
    2. Document viewer: `okular`, `ebook-tools`, `kdegraphics-mobipocket`, `unarchiver`
    3. Image viewer: `gwenview`, `kimageformats`, `qt6-imageformats`
    4. Video player ([mpv](https://wiki.archlinux.org/title/Mpv) based): `haruna`, `yt-dlp`
    5. Archiving tool: `ark`, `7zip`
    6. Screenshot tool: `spectacle`
    7. Calculator: `kalk`
    8. Text editor: `kate`
    9. File searching tool: `kfind`
    10. Messaging: `signal-desktop`
    12. Webcam controls ([LogiTune](https://wiki.archlinux.org/title/Webcam_setup#Graphical)): `cameractrls`
    13. Wireless mouse ([LogiBolt](https://wiki.archlinux.org/title/Logitech_Unifying_Receiver)): `solaar`
    14. IDE: `emacs-wayland`
5. Configure [Git](https://wiki.archlinux.org/title/Git) and GitHub.
    ````
    $ sudo pacman -S git openssh
    ````
    1. Set the name and [email](https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-personal-account-on-github/managing-email-preferences/setting-your-commit-email-address?platform=linux) for git commits. Also set default editor and push behavior.
       ````
       $ git config --global user.name  "Your Name"
       $ git config --global user.email "your.email@github.com"
       $ git config --global core.editor "nano -w"
       $ git config --global push.default simple
       ````
    2. Configure SSH for GitHub interaction:
       1. Generate a new public and private SSH key pair using [OpenSSH](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent).
       2. Add SSH public key to the [GitHub account](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account).
6. Configure `rclone` for [Google Drive backup](https://wiki.archlinux.org/title/List_of_applications/Internet#Cloud_synchronization_clients).
    ````
    $ sudo pacman -S rclone
    ````
    1. Create your own Google Drive OAuth2 client ID for rclone:
        1. Log into the [Google API Console](https://console.developers.google.com/) with your Google account. It doesn't matter what Google account you use. (It need not be the same account as the Google Drive you want to access.
        2. Select a project or create a new project.
        3. Under "ENABLE APIS AND SERVICES" search for "Drive", and enable the "Google Drive API".
        4. Click "Oauth Consent Screen" in the left panel and select user type "External". Then add Application name (anything you want) and save.
        5. Click "Credentials" in the left panel. Then click on "+ CREATE CREDENTIALS" button at the top of the screen, then select "OAuth client ID". Select Application type as "Desktop app", enter whaever client anme you want and click create.
        6. It will show you a client ID and client secret. Use these values in rclone config.
    2. Now [configure rclone](https://rclone.org/drive/) for Google Drive via Terminal: `rclone config` and follow the steps. Remember to use the Client ID and client secret we created above. Since we created this API for personal use, we won't be submitting it for verfication. Hence don't be alarmed by the very scary confirmation screen shown when we connect via your browser for rclone to be able to get its token-id.  Also, if you want to fetch Google Docs as links (instead of converting them to .odt etc) from Google Drive, in "advance-config" set "export-formats" to "link.html".
    3. Sync files using "[copy](https://rclone.org/commands/rclone_copy/)" and NOT "[sync](https://rclone.org/commands/rclone_sync/)": `rclone copy source:path dest:path [flags]`. For example, to sync all files from "New Folder" Google Drive (named: Drive) to PC (folder: home) and view the progress, type: `rclone copy Drive:"New Folder" /home -P`.  Google Drive tend to have duplicate files since it allows same names files in same folder, in that case use [dedupe](https://rclone.org/commands/rclone_dedupe/) to delete all duplicate files.
7. Configure snapper for automatic `/` snapshots [per the Wiki](https://wiki.archlinux.org/title/Snapper#Configuration_of_snapper_and_mount_point).
    ````
    $ sudo su
    # pacman -S snapper
    ````
    1. Unmount `/.snapshots`
       ````
       # btrfs subvolume list -t /
       # lsblk --fs
       # blkid
       # umount /.snapshots
       # rm -r /.snapshots
       ````
    2. Create a new snapper configuration named `root` for the Btrfs subvolume at `/`.
        ````
        # snapper -c root create-config /
        # sudo btrfs subvolume list /
        # btrfs subvolume delete /.snapshots
        # mkdir /.snapshots
        # mount -o noatime,compress=zstd:1,subvol=@snapshots /dev/root_partition /.snapshots
        ````
        This will create a configuration file at `/etc/snapper/configs/root`. When you delete config file, then also delete its entry from [`/etc/conf.d/snapper`](https://github.com/openSUSE/snapper/issues/371#issuecomment-1451093540) to read `SNAPPER_CONFIGS=""`. 
    3. Make this mount permanent by adding an entry to `fstab`. 
        ````
        # btrfs subvolume list -t /
        # lsblk --fs
        # blkid
        # nano /etc/fstab
        # mount -a
        # chmod 750 /.snapshots
        # chown :wheel /.snapshots
        ````
    4. Use [systemd timer units](https://wiki.archlinux.org/title/Systemd/Timers) for automatic timeline snapshots and cleanup. 
        ````
        # systemctl enable --now snapper-timeline.timer
        # systemctl enable --now snapper-cleanup.timer
        # systemctl edit --full snapper-timeline.timer
        # systemctl edit --full snapper-cleanup.timer
        ````
        For taking snapshots use realtime timer `OnCalendar=hourly` in `snapper-timeline.timer` unit and for cleanup use monotomic timer `OnBootSec=10m` and `OnUnitActiveSec=1h` in `snapper-cleanup.timer` unit. Unlike Timeshift, we will [not use cron job](https://wiki.archlinux.org/title/Cron#Installation). 
    5. Set snapshot limits by editing `/etc/snapper/configs/root`
       ````
       # limit for number cleanup
       NUMBER_MIN_AGE="1800"
       NUMBER_LIMIT="10"
       NUMBER_LIMIT_IMPORTANT="5"

       # limits for timeline cleanup
       TIMELINE_MIN_AGE="1800"
       TIMELINE_LIMIT_HOURLY="5"
       TIMELINE_LIMIT_DAILY="7"
       TIMELINE_LIMIT_WEEKLY="0"
       TIMELINE_LIMIT_MONTHLY="0"
       TIMELINE_LIMIT_YEARLY="0"

       # limits for empty pre-post-pair cleanup
       EMPTY_PRE_POST_MIN_AGE="1800"
       ````
       Here 1800 seconds = 30 min.
    6. Use [`snap-pac`](https://wiki.archlinux.org/title/Snapper#Wrapping_pacman_transactions_in_snapshots) to make pacman automatically use snapper to create pre/post snapshots.
       ````
       # pacman -S snap-pac
       ````
    7. We can use the [`grub-btrfs` daemon](https://github.com/Antynea/grub-btrfs?tab=readme-ov-file#-automatically-update-grub-upon-snapshot-creation-or-deletion) to automatically update GRUB upon snapshot creation or deletion, and avoid dependency on LiveUSB for restoring snapshots.
       ````
       # pacman -S grub-btrfs inotify-tools
       # systemctl enable --now grub-btrfsd
       ````
       Then enable booting into read-only snapshots using [overlay filesystem](https://github.com/Antynea/grub-btrfs/blob/master/initramfs/readme.md) by adding `grub-btrfs-overlayfs` to the end of the `HOOKS` array in `/etc/mkinitcpio.conf` and regenerating the `initramfs`.
       ````
       # nano /etc/mkinitcpio.conf
       # mkinitcpio -P
       ````
       If you try to boot from these read-only snapshots available in GRUB menu, the following warning/error might appear:
       ````
       ********************* WARNING *********************
       * The root device is not configured to be mounted *
       * read-write! It may be fsck'd again later.       *
       ***************************************************
       [FAILED] Failed to start Remount Root and Kernel File Systems.
       ````
       Here the `WARNING` just confirms that our snapshot is read-only and `[FAILED]` confirms that systemd failed to mount the underlying read-only root filesystem. Despite this "failure" message, the boot process should continue using OverlayFS's temporary read-write upper layer, leaving the original Btrfs snapshot untouched. 
10. Reboot and check if things if the things are as expected. 

## Maintainance

1. When refreshing the package database, always do a full upgrade.
   ````
   # pacman -Syu
   ````
2. Uninstall pacakge along with its dependecies.
   ````
   # pacman -Rs <package>
   ````
3. Recursively removing orphaned packages that were installed as a dependency but now, no other packages depend on them.
   ````
   # pacman -Qdtq | pacman -Rns -
   ````
4. To list all foreign packages that may no longer be in the remote repositories, but still may be on your local system. 
   ````
   # use pacman -Qm.
   ````
   This list will include packages that have been installed manually (e.g., from the AUR). 
5. To get a comprehensive snapshot of the Linux system use `inxi`
   ```` 
   # pacman -S inxi
   # inxi -Fxz #system information google to learn more about inxi
   ````
6. Use [`nvme`](https://man.archlinux.org/man/nvme.1) to probe the health of [SSD](https://wiki.archlinux.org/title/Solid_state_drive/NVMe).  
   ````
   # pacman -S nvme-cli 
   # nvme smart-log /dev/nvme0n1" #NVMe info
   ````
7. To view a list of snapshots under `root` configurations.
   ````
   # snapper -c root list
   ````
8. If GUI fails then can use [arch-chroot](https://wiki.archlinux.org/title/Chroot) or [tty](https://wiki.archlinux.org/title/Keyboard_shortcuts#Xorg_and_Wayland).
9. To restore `/` using one of snapper's snapshots, we need access to OverlayFS (either via [LiveUSB](https://wiki.archlinux.org/title/USB_flash_installation_medium) or `grub-btrfs`) and [follow these steps](https://wiki.archlinux.org/title/Snapper#Restoring_/_to_its_previous_snapshot).
    1. Mount the toplevel subvolume.
       ````
       # fdisk -l
       # mount /dev/root_partition /mnt
       # lsblk --fs
       # btrfs subvolume list -t /mnt
       ````
    2. Move `@` to another location (e.g. `/@.broken`) to save a copy of the current system.
       ````
       # mv /mnt/@ /mnt/@.broken
       # btrfs subvolume list -t /mnt
       ````
    3. Find the `number` of the snapshot that you want to recover:
       ````
       # grep -r '<date>' /mnt/@snapshots/*/info.xml
       ````
    4. Create a read-write snapshot of the read-only snapshot snapper took: 
       ````          
       # btrfs subvolume snapshot /mnt/@snapshots/<number>/snapshot /mnt/@
       ````
    5. Check `fstab` is correct.
       ````
       # cat /mnt/etc/fstab
       ````
    6. Unmount the top-level subvolume (ID=5), then mount `@` to `/mnt` and your ESP or boot partition to the appropriate mount point.
       ````
       # umount /mnt
       # mount -o noatime,compress=zstd:1,subvol=@ /dev/root_partition /mnt
       # mount /dev/efi_system_partition /mnt/efi
       ````
    7. If using LiveUSB then Change root to your restored snapshot before regenerating initramfs image.
       ````
       # arch-chroot /mnt     
       # mkinitcpio -P
       # exit
       # reboot
       ````
    8. If everything is as expected then delete the broken snapshot.
       ````
       # btrfs subvolume delete /@.broken
       ````
